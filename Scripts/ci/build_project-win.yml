parameters:
  name: ''
  path: ''
  graphics: 'NANOVG'
  target: 'All'
  artifactName: ''
  srcRepo: 'none'
  srcBranch: 'master'

steps:
  - bash: |
      echo srcRepo parameter = ${{parameters.srcRepo}}
      if [ ${{ parameters.srcRepo }} != none ]
      then
        if [ ! -d ./${{parameters.path}} ]
        then
          mkdir -p ./${{parameters.path}}
        fi
        cd ./${{parameters.path}}
        git clone --recursive -b ${{parameters.srcBranch}} ${{parameters.srcRepo}} ${{parameters.name}}
      else
        echo no remote repo argument supplied, building local project ${{parameters.path}}/${{parameters.name}} ...
      fi
    env:
      GITHUB_PAT: $(GITHUB_PAT)
    displayName: (Optionally) clone ${{parameters.name}} repo

  - bash: |
      graphics=${{parameters.graphics}}
      if [ $graphics = "SKIA" ]
      then
        cd ./${{parameters.path}}/${{parameters.name}}/config
        sed -i.bu 's/IGRAPHICS_NANOVG;IGRAPHICS_GL2/IGRAPHICS_SKIA;IGRAPHICS_GL2/' ${{parameters.name}}-win.props
      fi
    displayName: Set graphics string to ${{parameters.graphics}}

  # ============================================================
  # x64 Builds
  # ============================================================

  - task: VSBuild@1
    inputs:
      solution: '${{parameters.path}}/${{parameters.name}}/${{parameters.name}}.sln'
      vsVersion: '17.0'
      platform: x64
      msbuildArgs: /t:${{parameters.name}}-vst2
      configuration: '${{parameters.configuration}}'
    displayName: Compile ${{parameters.name}} VST2 x64
    condition: eq(variables.build_vst2, True)

  - task: VSBuild@1
    inputs:
      solution: '${{parameters.path}}/${{parameters.name}}/${{parameters.name}}.sln'
      vsVersion: '17.0'
      platform: x64
      msbuildArgs: /t:${{parameters.name}}-vst3
      configuration: '${{parameters.configuration}}'
    displayName: Compile ${{parameters.name}} VST3 x64
    condition: eq(variables.build_vst3, True)

  - task: VSBuild@1
    inputs:
      solution: '${{parameters.path}}/${{parameters.name}}/${{parameters.name}}.sln'
      vsVersion: '17.0'
      platform: x64
      msbuildArgs: /t:${{parameters.name}}-clap
      configuration: '${{parameters.configuration}}'
    displayName: Compile ${{parameters.name}} CLAP x64
    condition: eq(variables.build_clap, True)

  - task: VSBuild@1
    inputs:
      solution: '${{parameters.path}}/${{parameters.name}}/${{parameters.name}}.sln'
      vsVersion: '17.0'
      platform: x64
      msbuildArgs: /t:${{parameters.name}}-aax
      configuration: '${{parameters.configuration}}'
    displayName: Compile ${{parameters.name}} AAX x64
    condition: eq(variables.build_aax, True)

  - task: VSBuild@1
    inputs:
      solution: '${{parameters.path}}/${{parameters.name}}/${{parameters.name}}.sln'
      vsVersion: '17.0'
      platform: x64
      msbuildArgs: /t:${{parameters.name}}-app
      configuration: '${{parameters.configuration}}'
    displayName: Compile ${{parameters.name}} APP x64
    condition: eq(variables.build_app, True)

  # ============================================================
  # ARM64EC Builds (Skia not yet supported for ARM64EC)
  # ============================================================

  - task: VSBuild@1
    inputs:
      solution: '${{parameters.path}}/${{parameters.name}}/${{parameters.name}}.sln'
      vsVersion: '17.0'
      platform: ARM64EC
      msbuildArgs: /t:${{parameters.name}}-vst2
      configuration: '${{parameters.configuration}}'
    displayName: Compile ${{parameters.name}} VST2 ARM64EC
    condition: and(eq(variables.build_vst2, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - task: VSBuild@1
    inputs:
      solution: '${{parameters.path}}/${{parameters.name}}/${{parameters.name}}.sln'
      vsVersion: '17.0'
      platform: ARM64EC
      msbuildArgs: /t:${{parameters.name}}-vst3
      configuration: '${{parameters.configuration}}'
    displayName: Compile ${{parameters.name}} VST3 ARM64EC
    condition: and(eq(variables.build_vst3, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - task: VSBuild@1
    inputs:
      solution: '${{parameters.path}}/${{parameters.name}}/${{parameters.name}}.sln'
      vsVersion: '17.0'
      platform: ARM64EC
      msbuildArgs: /t:${{parameters.name}}-clap
      configuration: '${{parameters.configuration}}'
    displayName: Compile ${{parameters.name}} CLAP ARM64EC
    condition: and(eq(variables.build_clap, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - task: VSBuild@1
    inputs:
      solution: '${{parameters.path}}/${{parameters.name}}/${{parameters.name}}.sln'
      vsVersion: '17.0'
      platform: ARM64EC
      msbuildArgs: /t:${{parameters.name}}-aax
      configuration: '${{parameters.configuration}}'
    displayName: Compile ${{parameters.name}} AAX ARM64EC
    condition: and(eq(variables.build_aax, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - task: VSBuild@1
    inputs:
      solution: '${{parameters.path}}/${{parameters.name}}/${{parameters.name}}.sln'
      vsVersion: '17.0'
      platform: ARM64EC
      msbuildArgs: /t:${{parameters.name}}-app
      configuration: '${{parameters.configuration}}'
    displayName: Compile ${{parameters.name}} APP ARM64EC
    condition: and(eq(variables.build_app, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  # ============================================================
  # Organize ARM64EC Artifacts FIRST (uses cp, so bundles remain for x64)
  # ============================================================

  - bash: |
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/APP_ARM64EC/${{parameters.name}}
      cp ${{parameters.path}}/${{parameters.name}}/build-win/${{parameters.name}}_ARM64EC.exe $BUILD_ARTIFACTSTAGINGDIRECTORY/APP_ARM64EC/${{parameters.name}}/
      cp ${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-app_ARM64EC.pdb $BUILD_ARTIFACTSTAGINGDIRECTORY/APP_ARM64EC/${{parameters.name}}/
    displayName: Organize APP ARM64EC artifact
    condition: and(eq(variables.build_app, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - bash: |
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/VST3_ARM64EC/${{parameters.name}}
      # Copy entire VST3 bundle (contains arm64ec-win subfolder)
      if [ -d "${{parameters.path}}/${{parameters.name}}/build-win/${{parameters.name}}.vst3" ]; then
        cp -r ${{parameters.path}}/${{parameters.name}}/build-win/${{parameters.name}}.vst3 $BUILD_ARTIFACTSTAGINGDIRECTORY/VST3_ARM64EC/${{parameters.name}}/
      fi
      cp ${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-vst3_ARM64EC.pdb $BUILD_ARTIFACTSTAGINGDIRECTORY/VST3_ARM64EC/${{parameters.name}}/
    displayName: Organize VST3 ARM64EC artifact
    condition: and(eq(variables.build_vst3, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - bash: |
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/VST2_ARM64EC/${{parameters.name}}
      cp ${{parameters.path}}/${{parameters.name}}/build-win/${{parameters.name}}_ARM64EC.dll $BUILD_ARTIFACTSTAGINGDIRECTORY/VST2_ARM64EC/${{parameters.name}}/
      cp ${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-vst2_ARM64EC.pdb $BUILD_ARTIFACTSTAGINGDIRECTORY/VST2_ARM64EC/${{parameters.name}}/
    displayName: Organize VST2 ARM64EC artifact
    condition: and(eq(variables.build_vst2, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - bash: |
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/AAX_ARM64EC/${{parameters.name}}
      # Copy entire AAX bundle
      if [ -d "${{parameters.path}}/${{parameters.name}}/build-win/${{parameters.name}}.aaxplugin" ]; then
        cp -r ${{parameters.path}}/${{parameters.name}}/build-win/${{parameters.name}}.aaxplugin $BUILD_ARTIFACTSTAGINGDIRECTORY/AAX_ARM64EC/${{parameters.name}}/
      fi
      cp ${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-aax_ARM64EC.pdb $BUILD_ARTIFACTSTAGINGDIRECTORY/AAX_ARM64EC/${{parameters.name}}/
    displayName: Organize AAX ARM64EC artifact
    condition: and(eq(variables.build_aax, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - bash: |
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/CLAP_ARM64EC/${{parameters.name}}
      if [ -f "${{parameters.path}}/${{parameters.name}}/build-win/clap/ARM64EC/Release/${{parameters.name}}.clap" ]; then
        cp ${{parameters.path}}/${{parameters.name}}/build-win/clap/ARM64EC/Release/${{parameters.name}}.clap $BUILD_ARTIFACTSTAGINGDIRECTORY/CLAP_ARM64EC/${{parameters.name}}/
      fi
      if [ -f "${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-clap_ARM64EC.pdb" ]; then
        cp ${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-clap_ARM64EC.pdb $BUILD_ARTIFACTSTAGINGDIRECTORY/CLAP_ARM64EC/${{parameters.name}}/
      fi
    displayName: Organize CLAP ARM64EC artifact
    condition: and(eq(variables.build_clap, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  # ============================================================
  # Organize x64 Artifacts (uses mv, runs after ARM64EC copies)
  # ============================================================

  - bash: |
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/APP/${{parameters.name}}
      mv ${{parameters.path}}/${{parameters.name}}/build-win/${{parameters.name}}_x64.exe $BUILD_ARTIFACTSTAGINGDIRECTORY/APP/${{parameters.name}}
      mv ${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-app_x64.pdb $BUILD_ARTIFACTSTAGINGDIRECTORY/APP/${{parameters.name}}
    displayName: Organize APP x64 artifact
    condition: eq(variables.build_app, True)

  - bash: |
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/VST3/${{parameters.name}}
      mv ${{parameters.path}}/${{parameters.name}}/build-win/${{parameters.name}}.vst3* $BUILD_ARTIFACTSTAGINGDIRECTORY/VST3/${{parameters.name}} # must move VST3 first
      mv ${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-vst3_x64.pdb $BUILD_ARTIFACTSTAGINGDIRECTORY/VST3/${{parameters.name}}
    displayName: Organize VST3 x64 artifact
    condition: eq(variables.build_vst3, True)

  - bash: |
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/VST2/${{parameters.name}}
      mv ${{parameters.path}}/${{parameters.name}}/build-win/${{parameters.name}}_x64.dll $BUILD_ARTIFACTSTAGINGDIRECTORY/VST2/${{parameters.name}}
      mv ${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-vst2_x64.pdb $BUILD_ARTIFACTSTAGINGDIRECTORY/VST2/${{parameters.name}}
    displayName: Organize VST2 x64 artifact
    condition: eq(variables.build_vst2, True)

  - bash: |
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/AAX/${{parameters.name}}
      mv ${{parameters.path}}/${{parameters.name}}/build-win/${{parameters.name}}.aaxplugin* $BUILD_ARTIFACTSTAGINGDIRECTORY/AAX/${{parameters.name}}
      mv ${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-aax_x64.pdb $BUILD_ARTIFACTSTAGINGDIRECTORY/AAX/${{parameters.name}}
    displayName: Organize AAX x64 artifact
    condition: eq(variables.build_aax, True)

  - bash: |
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/CLAP/${{parameters.name}}
      if [ -f "${{parameters.path}}/${{parameters.name}}/build-win/clap/x64/Release/${{parameters.name}}.clap" ]; then
        mv ${{parameters.path}}/${{parameters.name}}/build-win/clap/x64/Release/${{parameters.name}}.clap $BUILD_ARTIFACTSTAGINGDIRECTORY/CLAP/${{parameters.name}}/
      fi
      if [ -f "${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-clap_x64.pdb" ]; then
        mv ${{parameters.path}}/${{parameters.name}}/build-win/pdbs/${{parameters.name}}-clap_x64.pdb $BUILD_ARTIFACTSTAGINGDIRECTORY/CLAP/${{parameters.name}}/
      fi
    displayName: Organize CLAP x64 artifact
    condition: eq(variables.build_clap, True)

  # ============================================================
  # Publish x64 Artifacts
  # ============================================================

  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'WIN_VST2_${{parameters.artifactName}}'
      targetPath: '$(Build.ArtifactStagingDirectory)/VST2/${{parameters.name}}'
    displayName: Publish ${{parameters.name}} VST2 x64
    condition: eq(variables.build_vst2, True)

  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'WIN_VST3_${{parameters.artifactName}}'
      targetPath: '$(Build.ArtifactStagingDirectory)/VST3/${{parameters.name}}'
    displayName: Publish ${{parameters.name}} VST3 x64
    condition: eq(variables.build_vst3, True)

  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'WIN_AAX_${{parameters.artifactName}}'
      targetPath: '$(Build.ArtifactStagingDirectory)/AAX/${{parameters.name}}'
    displayName: Publish ${{parameters.name}} AAX x64
    condition: eq(variables.build_aax, True)

  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'WIN_CLAP_${{parameters.artifactName}}'
      targetPath: '$(Build.ArtifactStagingDirectory)/CLAP/${{parameters.name}}'
    displayName: Publish ${{parameters.name}} CLAP x64
    condition: eq(variables.build_clap, True)

  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'WIN_APP_${{parameters.artifactName}}'
      targetPath: '$(Build.ArtifactStagingDirectory)/APP/${{parameters.name}}'
    displayName: Publish ${{parameters.name}} APP x64
    condition: eq(variables.build_app, True)

  # ============================================================
  # Publish ARM64EC Artifacts
  # ============================================================

  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'WIN_VST2_ARM64EC_${{parameters.artifactName}}'
      targetPath: '$(Build.ArtifactStagingDirectory)/VST2_ARM64EC/${{parameters.name}}'
    displayName: Publish ${{parameters.name}} VST2 ARM64EC
    condition: and(eq(variables.build_vst2, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'WIN_VST3_ARM64EC_${{parameters.artifactName}}'
      targetPath: '$(Build.ArtifactStagingDirectory)/VST3_ARM64EC/${{parameters.name}}'
    displayName: Publish ${{parameters.name}} VST3 ARM64EC
    condition: and(eq(variables.build_vst3, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'WIN_AAX_ARM64EC_${{parameters.artifactName}}'
      targetPath: '$(Build.ArtifactStagingDirectory)/AAX_ARM64EC/${{parameters.name}}'
    displayName: Publish ${{parameters.name}} AAX ARM64EC
    condition: and(eq(variables.build_aax, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'WIN_CLAP_ARM64EC_${{parameters.artifactName}}'
      targetPath: '$(Build.ArtifactStagingDirectory)/CLAP_ARM64EC/${{parameters.name}}'
    displayName: Publish ${{parameters.name}} CLAP ARM64EC
    condition: and(eq(variables.build_clap, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))

  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'WIN_APP_ARM64EC_${{parameters.artifactName}}'
      targetPath: '$(Build.ArtifactStagingDirectory)/APP_ARM64EC/${{parameters.name}}'
    displayName: Publish ${{parameters.name}} APP ARM64EC
    condition: and(eq(variables.build_app, True), eq(variables.build_arm64ec, True), ne('${{parameters.graphics}}', 'SKIA'))
