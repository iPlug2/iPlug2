<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAME_PLACEHOLDER</title>
    <link href="styles/style.css" rel="stylesheet" type="text/css"/>
    <!-- Plugin bundle must load first to initialize Module -->
    <script src="scripts/NAME_PLACEHOLDER-bundle.js"></script>
    <!-- Resource data files (generated by file_packager) -->
    <script src="fonts.js"></script>
    <script src="svgs.js"></script>
    <script src="imgs.js"></script>
    <script src="imgs@2x.js"></script>
  </head>
  <body class="HOST_RESIZE_CLASS_PLACEHOLDER">
    <!-- Plugin web component -->
    <iplug-NAME_PLACEHOLDER_LC></iplug-NAME_PLACEHOLDER_LC>

    <!-- Floating control panel -->
    <div id="controls" class="hidden">
      <button type="button" id="startBtn" disabled>Start Audio</button>
      <button type="button" id="fullscreenBtn">Fullscreen</button>
      <select id="midiInSelect" disabled><option>MIDI In</option></select>
      <select id="midiOutSelect" disabled><option>MIDI Out</option></select>
    </div>

    <!-- Loading overlay -->
    <div id="loading">
      <div id="loading-content">
        <div id="status">Loading...</div>
        <progress id="progress" value="0" max="100"></progress>
      </div>
    </div>

    <script type='text/javascript'>
      const pluginElement = document.querySelector('iplug-NAME_PLACEHOLDER_LC');
      let pluginController = null;

      // Prevent default behaviors
      document.addEventListener("keydown", e => { if(e.keyCode === 9) e.preventDefault(); });
      document.addEventListener("touchmove", e => e.preventDefault(), {passive: false});

      function toggleFullScreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(err => {
            console.log(`Fullscreen error: ${err.message}`);
          });
        } else {
          document.exitFullscreen();
        }
      }

      function initMidiComboBox(isOutput, selectId) {
        const combo = document.getElementById(selectId);
        combo.innerHTML = '';
        if (!navigator.requestMIDIAccess) return;

        navigator.requestMIDIAccess().then(midiIF => {
          const ports = isOutput ? midiIF.outputs : midiIF.inputs;
          for (let port of ports.values()) {
            const option = new Option(port.name);
            option.port = port;
            combo.appendChild(option);
          }
          if (combo.options.length > 0) {
            combo.removeAttribute("disabled");
            combo.onchange = e => {
              const port = e.target.options[e.target.selectedIndex].port;
              if (isOutput) {
                pluginController.midiOut = port;
              } else {
                port.onmidimessage = msg => {
                  if (pluginController) {
                    pluginController.sendMidi(msg.data[0], msg.data[1] || 0, msg.data[2] || 0);
                  }
                };
              }
            };
            combo.onchange({ target: combo });
          }
        });
      }

      function onAudioReady() {
        document.getElementById('controls').classList.remove('hidden');
        const btn = document.getElementById('startBtn');
        btn.textContent = 'Stop Audio';
        btn.disabled = false;
        btn.onclick = stopWebAudio;
        initMidiComboBox(false, 'midiInSelect');
        initMidiComboBox(true, 'midiOutSelect');
      }

      function stopWebAudio() {
        if (pluginController) {
          pluginController.stopAudio();
          const btn = document.getElementById('startBtn');
          btn.textContent = 'Start Audio';
          btn.onclick = resumeWebAudio;
        }
      }

      function resumeWebAudio() {
        if (pluginController) {
          pluginController.startAudio();
          const btn = document.getElementById('startBtn');
          btn.textContent = 'Stop Audio';
          btn.onclick = stopWebAudio;
        }
      }

      async function startWebAudio() {
        pluginController = new IPlugController('NAME_PLACEHOLDER', pluginElement.module);
        pluginElement.controller = pluginController;

        pluginController.onReadyCallback = () => {
          console.log("AudioWorklet ready!");
          const numInputs = pluginElement.numInputs;

          if (numInputs > 0) {
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
              .then(stream => {
                if (Module.audioContext && Module.workletNode) {
                  const audioSource = Module.audioContext.createMediaStreamSource(stream);
                  audioSource.connect(Module.workletNode);
                }
                pluginController.startAudio();
                onAudioReady();
              })
              .catch(err => {
                console.log('Mic access denied: ' + err);
                pluginController.startAudio();
                onAudioReady();
              });
          } else {
            pluginController.startAudio();
            onAudioReady();
          }
        };

        try {
          await pluginController.init({ sampleRate: 0 });
        } catch (err) {
          console.error("Failed to initialize plugin:", err);
        }
      }

      // Listen for ready event from web component
      pluginElement.addEventListener('ready', () => {
        document.getElementById('startBtn').removeAttribute("disabled");
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('controls').classList.remove('hidden');
      });

      window.onerror = event => {
        if (window.Module) {
          Module.setStatus('Error - see console');
          Module.setStatus = text => { if (text) console.error('[error] ' + text); };
        }
      };

      // Button handlers
      document.getElementById('startBtn').onclick = startWebAudio;
      document.getElementById('fullscreenBtn').onclick = toggleFullScreen;

      // Auto-start audio on first user interaction
      function onFirstInteraction() {
        document.removeEventListener('click', onFirstInteraction);
        document.removeEventListener('keydown', onFirstInteraction);
        document.removeEventListener('touchstart', onFirstInteraction);
        if (!document.getElementById('startBtn').disabled) {
          startWebAudio();
        }
      }
      document.addEventListener('click', onFirstInteraction);
      document.addEventListener('keydown', onFirstInteraction);
      document.addEventListener('touchstart', onFirstInteraction);
    </script>
  </body>
</html>
