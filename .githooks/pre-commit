#!/bin/bash
#
# Git pre-commit hook for iPlug2
# Validates author configuration and basic code checks
#
# To enable: git config core.hooksPath .githooks
#

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

error() {
    echo -e "${RED}ERROR:${NC} $1"
}

warn() {
    echo -e "${YELLOW}WARNING:${NC} $1"
}

# Check that user.name is set
name=$(git config user.name)
if [[ -z "$name" ]]; then
    error "Git user.name is not configured"
    echo "Run: git config user.name \"Your Name\""
    exit 1
fi

# Check that user.email is set
email=$(git config user.email)
if [[ -z "$email" ]]; then
    error "Git user.email is not configured"
    echo "Run: git config user.email \"your@email.com\""
    exit 1
fi

# Warn if email looks like a placeholder
if [[ "$email" =~ (example\.com|test@|noreply@) ]]; then
    warn "Email '$email' looks like a placeholder. Consider using a real email."
fi

# Check for files with trailing whitespace (optional - just warn)
files_with_trailing_ws=$(git diff --cached --name-only | xargs -I {} sh -c 'git show ":{}'" 2>/dev/null | grep -l '[[:space:]]$' 2>/dev/null || true)
if [[ -n "$files_with_trailing_ws" ]]; then
    warn "Some staged files have trailing whitespace"
fi

# Prevent commits of common debug patterns
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|h|c|hpp)$' || true)
if [[ -n "$staged_files" ]]; then
    # Check for debug patterns that shouldn't be committed
    for file in $staged_files; do
        if git show ":$file" 2>/dev/null | grep -qE '(TODO.*REMOVE|FIXME.*DEBUG|#if 0.*DEBUG)'; then
            warn "File '$file' contains debug markers that may need review"
        fi
    done
fi

# Check for large files being added (> 1MB)
large_files=$(git diff --cached --name-only --diff-filter=A | while read f; do
    if [[ -f "$f" ]]; then
        size=$(wc -c < "$f" 2>/dev/null || echo 0)
        if [[ $size -gt 1048576 ]]; then
            echo "$f"
        fi
    fi
done)
if [[ -n "$large_files" ]]; then
    warn "Large files being added (>1MB):"
    echo "$large_files"
    echo "Consider using Git LFS for binary assets"
fi

exit 0
